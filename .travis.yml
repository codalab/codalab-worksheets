language: python
sudo: required
services:
  - docker
env:
  - CODALAB_USERNAME=codalab CODALAB_PASSWORD=testpassword
  # Make sure we only fire the builds of our docker images on master and staging
  - BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}
python:
  - 3.6
  - 2.7
before_install:
  - docker --version
  - chmod +x ./travis_build_images.sh
install:
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then pip install sqlalchemy; fi
#   add packages required by tests (mock and nose are on Travis VM by default)
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then pip install pyyaml psutil; fi
  - sudo apt-get update
  - sudo apt-get install -y sshpass python-virtualenv
  - sudo apt-get install -y libmysqlclient-dev
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./setup.sh server; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./venv/bin/pip install --upgrade setuptools; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./venv/bin/pip install --upgrade pip; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 3.6 ]]; then virtualenv -p python3.6 venv; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 3.6 ]]; then ./venv/bin/pip install --upgrade black==18.9b0; fi
before_script:
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then mysql -e "CREATE DATABASE codalab_bundles;"; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./codalab/bin/cl config server/engine_url mysql://root@localhost:3306/codalab_bundles; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./codalab/bin/cl config cli/default_address http://localhost:2900; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./codalab/bin/cl config workers/default_docker_image ubuntu:14.04; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./scripts/create-root-user.py $CODALAB_PASSWORD; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./codalab/bin/cl server; fi &
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./codalab/bin/cl bundle-manager; fi &
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then printf "$CODALAB_USERNAME\n$CODALAB_PASSWORD\n" > /home/travis/.codalab/root.password; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then chmod 600 /home/travis/.codalab/root.password; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then sleep 15; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then pip install ./worker; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then cl-worker --server http://127.0.0.1:2900 --work-dir /home/travis/.codalab/worker-scratch --password-file /home/travis/.codalab/root.password --verbose; fi &
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then printf "$CODALAB_USERNAME\n$CODALAB_PASSWORD\n" | sshpass -p "" ./codalab/bin/cl work; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./codalab/bin/cl upload -c stuff; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then printf "$CODALAB_USERNAME\n$CODALAB_PASSWORD\n" | sshpass -p "" ./codalab/bin/cl rm ^; fi
script:
  - if [[ $TRAVIS_PYTHON_VERSION == 3.6 ]]; then ./venv/bin/black . --check; fi
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then ./venv/bin/python test-cli.py default; fi
deploy:
  # Build docker images using tag if we're on release branch with a semver tag
  # Otherwise if we're on master or staging build named branches
  - provider: script
    script:
      # remove first char of tag since it'll be 'v' and we strip that for docker image tags
      - ./travis_build_images.sh ${$TRAVIS_TAG:1}
    on:
      branch: release
      # only build on valid-looking semver tags
      tags: true
      condition: $TRAVIS_TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+
  - provider: script
    script:
      - ./travis_build_images.sh $TRAVIS_BRANCH
    on:
      # PR's also fire travis builds where 'branch' is the base branch
      # we don't want to build docker images for those
      condition: branch IN (master, staging) AND type IS push
